From 19e95899b9669f4f1aa1490058ac4fe22d965665 Mon Sep 17 00:00:00 2001
From: Alexey Lukyanchuk <skif@skif-web.ru>
Date: Sun, 19 May 2019 13:39:46 +0300
Subject: [PATCH 1/2] boot/grub2: memdisk option

Allows to create grub2 memdisk from specified directory

Signed-off-by: Alexey Lukyanchuk <skif@skif-web.ru>
---
 boot/grub2/Config.in |  7 +++++++
 boot/grub2/grub2.mk  | 15 +++++++++++++++
 2 files changed, 22 insertions(+)

diff --git a/boot/grub2/Config.in b/boot/grub2/Config.in
index e45133999e..2f0454fb80 100644
--- a/boot/grub2/Config.in
+++ b/boot/grub2/Config.in
@@ -118,6 +118,13 @@ config BR2_TARGET_GRUB2_INSTALL_TOOLS
 
 endif # BR2_TARGET_GRUB2
 
+config BR2_TARGET_GRUB2_MEMDISK_DIR
+	string "memdisk"
+	help
+	  Path to directory that will be a memdisk (-m option in 
+	  grub2-mkimage)
+	
+
 comment "grub2 needs a toolchain w/ wchar"
 	depends on BR2_TARGET_GRUB2_ARCH_SUPPORTS
 	depends on !BR2_USE_WCHAR
diff --git a/boot/grub2/grub2.mk b/boot/grub2/grub2.mk
index 65371f0170..eeaa8659cd 100644
--- a/boot/grub2/grub2.mk
+++ b/boot/grub2/grub2.mk
@@ -14,6 +14,7 @@
 GRUB2_BUILTIN_MODULES = $(call qstrip,$(BR2_TARGET_GRUB2_BUILTIN_MODULES))
 GRUB2_BUILTIN_CONFIG = $(call qstrip,$(BR2_TARGET_GRUB2_BUILTIN_CONFIG))
 GRUB2_BOOT_PARTITION = $(call qstrip,$(BR2_TARGET_GRUB2_BOOT_PARTITION))
+GRUB2_MEMDISK_DIR = $(call qstrip,$(BR2_TARGET_GRUB2_MEMDISK_DIR))
 
 ifeq ($(BR2_TARGET_GRUB2_I386_PC),y)
 GRUB2_IMAGE = $(BINARIES_DIR)/grub.img
@@ -86,6 +87,15 @@
 endef
 endif
 
+ifneq ($(GRUB2_MEMDISK_DIR),)
+GRUB2_POST_BUILD_HOOKS += GRUB2_MAKE_MEMDISK
+define GRUB2_MAKE_MEMDISK
+	mkdir -p $(@D)/grub2_memdisk
+	cp -a $(GRUB2_MEMDISK_DIR)/* $(@D)/grub2_memdisk/
+	tar -cvf $(@D)/memdisk.tar -C $(@D)/grub2_memdisk/ .
+endef
+endif
+
 define GRUB2_IMAGE_INSTALLATION
 	mkdir -p $(dir $(GRUB2_IMAGE))
 	$(HOST_DIR)/bin/grub-mkimage \
@@ -93,6 +103,7 @@
 		-O $(GRUB2_TUPLE) \
 		-o $(GRUB2_IMAGE) \
 		-p "$(GRUB2_PREFIX)" \
+		$(if $(BR2_TARGET_GRUB2_MEMDISK_DIR),-m $(@D)/memdisk.tar) \
 		$(if $(GRUB2_BUILTIN_CONFIG),-c $(GRUB2_BUILTIN_CONFIG)) \
 		$(GRUB2_BUILTIN_MODULES)
 	mkdir -p $(dir $(GRUB2_CFG))
-- 
2.20.1

